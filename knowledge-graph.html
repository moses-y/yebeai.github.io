<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Graph | Moses Yebei</title>
    <meta name="description" content="Interactive visualization of repository structures, languages, and relationships.">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîó</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #030303;
            --bg-secondary: #0a0a0a;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.06);
            --text-primary: #fafafa;
            --text-secondary: #888888;
            --text-tertiary: #555555;
            --accent: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
            --glass: rgba(255, 255, 255, 0.02);
            --glass-border: rgba(255, 255, 255, 0.05);
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: rgba(0, 0, 0, 0.02);
            --bg-card-hover: rgba(0, 0, 0, 0.05);
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --border: rgba(0, 0, 0, 0.08);
            --border-hover: rgba(0, 0, 0, 0.15);
            --glass: rgba(0, 0, 0, 0.02);
            --glass-border: rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 1rem 2rem;
            background: rgba(3, 3, 3, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        [data-theme="light"] nav {
            background: rgba(255, 255, 255, 0.8);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-logo {
            font-weight: 800;
            font-size: 1.25rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none;
        }

        .nav-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
            list-style: none;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .nav-links a:hover { color: var(--text-primary); background: var(--bg-card); }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .theme-toggle:hover { border-color: var(--border-hover); color: var(--text-primary); }
        [data-theme="light"] .theme-toggle .moon { display: none; }
        :not([data-theme="light"]) .theme-toggle .sun { display: none; }

        /* Controls Bar */
        .controls {
            position: fixed;
            top: 65px;
            left: 0;
            right: 0;
            z-index: 90;
            padding: 0.75rem 2rem;
            background: rgba(3, 3, 3, 0.6);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        [data-theme="light"] .controls {
            background: rgba(255, 255, 255, 0.6);
        }

        .controls select, .controls input {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.8rem;
        }

        .controls select:focus, .controls input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .controls label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .back-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: none;
            align-items: center;
            gap: 0.4rem;
        }

        .back-btn:hover { border-color: var(--accent); color: var(--text-primary); background: var(--bg-card-hover); }
        .back-btn.visible { display: flex; }

        .current-repo {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .current-repo.visible { display: flex; }

        .current-repo .repo-name {
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stats-bar {
            margin-left: auto;
            display: flex;
            gap: 1.5rem;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .stats-bar span strong {
            color: var(--text-secondary);
        }

        /* Graph Container */
        #graph-container {
            position: fixed;
            top: 120px;
            left: 0;
            right: 0;
            bottom: 0;
            transition: opacity 0.3s ease;
        }

        #graph-container.transitioning {
            opacity: 0;
        }

        #graph-container svg {
            width: 100%;
            height: 100%;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.8rem;
            color: var(--text-primary);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            max-width: 380px;
            z-index: 200;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .tooltip.visible {
            opacity: 1;
            animation: fade-in 0.15s ease-out;
        }

        .tooltip h4 {
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tooltip .detail {
            color: var(--text-secondary);
            font-size: 0.75rem;
            line-height: 1.4;
        }

        .tooltip .summary {
            color: var(--text-secondary);
            font-size: 0.7rem;
            line-height: 1.5;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            max-height: 120px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
        }

        .tooltip .tag {
            display: inline-block;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65rem;
            margin: 0.15rem 0.1rem;
            color: var(--text-secondary);
        }

        /* Side Panel */
        .side-panel {
            position: fixed;
            top: 120px;
            right: 0;
            width: 320px;
            bottom: 0;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            padding: 1.25rem;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 80;
        }

        .side-panel.open {
            transform: translateX(0);
            animation: slide-in 0.3s ease-out;
        }

        .side-panel h3 {
            font-size: 1rem;
            margin-bottom: 0.75rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .side-panel .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .panel-section {
            margin-bottom: 1rem;
        }

        .panel-section h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 0.4rem;
        }

        .panel-section .bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
            font-size: 0.8rem;
        }

        .panel-section .bar-fill {
            height: 6px;
            border-radius: 3px;
            background: var(--gradient);
            flex-shrink: 0;
        }

        .panel-section .bar-label {
            color: var(--text-secondary);
            min-width: 80px;
            font-size: 0.75rem;
        }

        .panel-section .bar-count {
            color: var(--text-tertiary);
            font-size: 0.7rem;
            margin-left: auto;
        }

        .panel-section .file-list {
            list-style: none;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .panel-section .file-list li {
            padding: 0.3rem 0.4rem;
            font-family: 'SF Mono', 'Fira Code', monospace;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .panel-section .file-list li:hover {
            background: var(--bg-card-hover);
        }

        .panel-section .bar {
            border-radius: 4px;
            padding: 0.2rem 0.4rem;
            margin: 0 -0.4rem;
            transition: background 0.15s;
        }

        .panel-section .bar:hover {
            background: var(--bg-card-hover);
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 1rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Node interactions */
        .node-circle {
            transition: filter 0.2s, transform 0.2s;
        }

        .node-circle.clickable {
            cursor: pointer;
        }

        .node-circle.clickable:hover {
            filter: brightness(1.2) drop-shadow(0 0 8px currentColor);
        }

        .node-group.dimmed .node-circle {
            opacity: 0.15;
        }

        .node-group.dimmed text {
            opacity: 0.15;
        }

        .link-line.dimmed {
            opacity: 0.05 !important;
        }

        .link-line.highlighted {
            opacity: 0.8 !important;
            stroke-width: 3px !important;
        }

        /* Ripple effect */
        @keyframes ripple {
            0% { r: 0; opacity: 0.6; }
            100% { r: 50; opacity: 0; }
        }

        .ripple {
            fill: var(--accent);
            pointer-events: none;
        }

        /* GitNexus-inspired animations */
        @keyframes breathe {
            0%, 100% {
                border-color: var(--border);
                box-shadow: 0 0 0 rgba(99, 102, 241, 0);
            }
            50% {
                border-color: var(--accent);
                box-shadow: 0 0 20px rgba(99, 102, 241, 0.15);
            }
        }

        @keyframes slide-in {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Apply breathing to selected nodes */
        .node-circle.selected {
            animation: breathe 3s ease-in-out infinite;
        }

        /* Smooth node entrance */
        .node-group {
            animation: fade-in 0.3s ease-out;
        }

        /* Custom scrollbar (GitNexus style) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Filter badge */
        .filter-badge {
            display: none;
            align-items: center;
            gap: 0.4rem;
            background: var(--accent);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .filter-badge.visible { display: flex; }

        .filter-badge .clear-filter {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-badge .clear-filter:hover {
            background: rgba(255,255,255,0.3);
        }

        /* GitHub button in panel */
        .github-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            text-decoration: none;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .github-btn:hover {
            border-color: var(--accent);
            background: var(--bg-card-hover);
        }

        /* Clickable hint */
        .click-hint {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            margin-top: 0.5rem;
            font-style: italic;
        }

        /* Depth slider */
        .depth-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .depth-control input[type="range"] {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            background: var(--border);
            border-radius: 2px;
            cursor: pointer;
        }

        .depth-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.15s;
        }

        .depth-control input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .depth-value {
            min-width: 20px;
            text-align: center;
            font-weight: 600;
            color: var(--accent);
        }

        /* Community toggle */
        .community-toggle {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .community-toggle:hover {
            border-color: var(--accent);
        }

        .community-toggle.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }

        .community-toggle input {
            display: none;
        }

        .toggle-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-tertiary);
            transition: background 0.2s;
        }

        .community-toggle.active .toggle-dot {
            background: var(--accent);
        }

        /* Community legend */
        .community-legend {
            display: none;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .community-legend.visible {
            display: flex;
        }

        .community-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 3px;
        }

        /* Selected node indicator */
        .selected-node-badge {
            display: none;
            align-items: center;
            gap: 0.4rem;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
        }

        .selected-node-badge.visible {
            display: flex;
        }

        .selected-node-badge .clear-selection {
            background: rgba(99, 102, 241, 0.2);
            border: none;
            color: var(--accent);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            nav { padding: 0.75rem 1rem; }
            .controls { padding: 0.5rem 1rem; font-size: 0.75rem; }
            .nav-title { display: none; }
            .stats-bar { display: none; }
            .side-panel { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-left">
            <a href="index.html" class="nav-logo">MY</a>
            <span class="nav-title">Code Graph</span>
            <ul class="nav-links">
                <li><a href="index.html">‚Üê Portfolio</a></li>
                <li><a href="index.html#projects">Projects</a></li>
            </ul>
        </div>
        <div class="nav-right">
            <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                <svg class="sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
                <svg class="moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
        </div>
    </nav>

    <!-- Controls -->
    <div class="controls">
        <button class="back-btn" id="back-btn" onclick="goBack()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            All Repos
        </button>
        <div class="current-repo" id="current-repo">
            <span>Viewing:</span>
            <span class="repo-name" id="current-repo-name"></span>
        </div>
        <div class="filter-badge" id="filter-badge">
            <span id="filter-label">JavaScript</span>
            <button class="clear-filter" onclick="clearLanguageFilter()">‚úï</button>
        </div>
        <label id="search-wrapper">
            Search:
            <input type="text" id="search" placeholder="Filter repos..." style="width:140px">
        </label>

        <!-- Community detection toggle -->
        <label class="community-toggle" id="community-toggle">
            <input type="checkbox" id="community-checkbox">
            <span class="toggle-dot"></span>
            Clusters
        </label>

        <!-- Depth filter -->
        <div class="depth-control" id="depth-control" style="display:none">
            <span>Depth:</span>
            <input type="range" id="depth-slider" min="1" max="5" value="5">
            <span class="depth-value" id="depth-value">‚àû</span>
        </div>

        <!-- Selected node badge -->
        <div class="selected-node-badge" id="selected-badge">
            <span id="selected-name">Node</span>
            <button class="clear-selection" onclick="clearSelection()">‚úï</button>
        </div>

        <!-- Community legend -->
        <div class="community-legend" id="community-legend"></div>

        <div class="stats-bar" id="stats-bar">
            <span>Repos: <strong id="stat-repos">0</strong></span>
            <span>Languages: <strong id="stat-langs">0</strong></span>
            <span>With Data: <strong id="stat-kg">0</strong></span>
        </div>
    </div>

    <!-- Graph -->
    <div id="graph-container">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <span>Loading code graph...</span>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Side Panel -->
    <div class="side-panel" id="side-panel">
        <button class="close-btn" onclick="closeSidePanel()">‚úï</button>
        <div id="panel-content"></div>
    </div>

    <!-- 3D Force Graph + Three.js extras -->
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three-spritetext@1.8.2/dist/three-spritetext.min.js"></script>
    <script src="https://unpkg.com/3d-force-graph@1.73.0/dist/3d-force-graph.min.js"></script>

    <script>
    // Theme
    const savedTheme = localStorage.getItem('theme') || 'dark';
    if (savedTheme === 'light') document.documentElement.setAttribute('data-theme', 'light');

    document.getElementById('theme-toggle').addEventListener('click', () => {
        const isLight = document.documentElement.getAttribute('data-theme') === 'light';
        document.documentElement.setAttribute('data-theme', isLight ? '' : 'light');
        localStorage.setItem('theme', isLight ? 'dark' : 'light');
    });

    // Color palette for languages
    const langColors = {
        'JavaScript': '#f1e05a', 'TypeScript': '#3178c6', 'Python': '#3572A5',
        'Go': '#00ADD8', 'Rust': '#dea584', 'Java': '#b07219', 'C++': '#f34b7d',
        'C': '#555555', 'C#': '#178600', 'Ruby': '#701516', 'PHP': '#4F5D95',
        'Swift': '#F05138', 'Kotlin': '#A97BFF', 'Dart': '#00B4AB',
        'Shell': '#89e051', 'HTML': '#e34c26', 'CSS': '#563d7c', 'SCSS': '#c6538c',
        'Vue': '#41b883', 'Svelte': '#ff3e00', 'JSX': '#f1e05a', 'TSX': '#3178c6',
        'YAML': '#cb171e', 'JSON': '#292929', 'Markdown': '#083fa1',
        'SQL': '#e38c00', 'Docker': '#384d54', 'Terraform': '#5C4EE5',
        'Elixir': '#6e4a7e', 'Lua': '#000080', 'Scala': '#c22d40',
        'R': '#198CE7', 'GraphQL': '#e10098', 'Zig': '#ec915c'
    };

    function getColor(name) {
        return langColors[name] || d3.schemeTableau10[Math.abs(hashStr(name)) % 10];
    }

    function hashStr(s) {
        let h = 0;
        for (let i = 0; i < s.length; i++) h = ((h << 5) - h + s.charCodeAt(i)) | 0;
        return h;
    }

    // State
    let allData = [];
    let currentView = 'ecosystem';
    let currentRepo = null;
    let filterLanguage = null;
    let communityMode = false;
    let selectedNodeId = null;
    let depthFilter = 5; // 5 = show all
    let nodeCommunities = new Map(); // nodeId -> communityId
    let currentNodes = [];
    let currentLinks = [];

    // Community colors (distinct, colorblind-friendly palette)
    const communityColors = [
        '#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6',
        '#06b6d4', '#ec4899', '#14b8a6', '#f97316', '#84cc16'
    ];

    // 3D Graph instance
    let graph3D = null;
    let highlightNodes = new Set();
    let highlightLinks = new Set();
    let hoverNode = null;

    // Load data
    async function loadData() {
        try {
            const resp = await fetch('forks.json');
            const data = await resp.json();
            allData = (data.forks || []).filter(f => f.knowledgeGraph);
            document.getElementById('stat-repos').textContent = data.forks?.length || 0;
            document.getElementById('stat-kg').textContent = allData.length;

            // Count unique languages
            const allLangs = new Set();
            allData.forEach(f => {
                if (f.knowledgeGraph?.languages) {
                    Object.keys(f.knowledgeGraph.languages).forEach(l => allLangs.add(l));
                }
            });
            document.getElementById('stat-langs').textContent = allLangs.size;

            document.getElementById('loading').style.display = 'none';
            renderGraph();
        } catch (e) {
            document.getElementById('loading').innerHTML =
                '<span style="color:#ef4444">Code graph data is not yet available. It will be generated during the next data update.</span>';
            console.error('Load error:', e);
        }
    }

    // ========== COMMUNITY DETECTION (Louvain-inspired) ==========
    function detectCommunities(nodes, links) {
        // Build adjacency list
        const adj = new Map();
        nodes.forEach(n => adj.set(n.id, []));
        links.forEach(l => {
            const src = typeof l.source === 'string' ? l.source : l.source.id;
            const tgt = typeof l.target === 'string' ? l.target : l.target.id;
            if (adj.has(src)) adj.get(src).push({ node: tgt, weight: l.value || 1 });
            if (adj.has(tgt)) adj.get(tgt).push({ node: src, weight: l.value || 1 });
        });

        // Initialize each node in its own community
        const community = new Map();
        nodes.forEach((n, i) => community.set(n.id, i));

        // Simple greedy modularity optimization (2 passes)
        for (let pass = 0; pass < 2; pass++) {
            let improved = true;
            while (improved) {
                improved = false;
                for (const node of nodes) {
                    const neighbors = adj.get(node.id) || [];
                    if (neighbors.length === 0) continue;

                    // Find best community among neighbors
                    const commCounts = new Map();
                    neighbors.forEach(({ node: nid, weight }) => {
                        const c = community.get(nid);
                        commCounts.set(c, (commCounts.get(c) || 0) + weight);
                    });

                    let bestComm = community.get(node.id);
                    let bestScore = 0;
                    commCounts.forEach((score, c) => {
                        if (score > bestScore) {
                            bestScore = score;
                            bestComm = c;
                        }
                    });

                    if (bestComm !== community.get(node.id)) {
                        community.set(node.id, bestComm);
                        improved = true;
                    }
                }
            }
        }

        // Renumber communities to be sequential
        const uniqueComms = [...new Set(community.values())];
        const commMap = new Map(uniqueComms.map((c, i) => [c, i]));
        const result = new Map();
        community.forEach((c, nodeId) => result.set(nodeId, commMap.get(c)));

        return result;
    }

    // ========== BFS DEPTH FILTER ==========
    function getNodesWithinDepth(startId, maxDepth, nodes, links) {
        if (maxDepth >= 5) {
            // Return all nodes
            return new Map(nodes.map(n => [n.id, 0]));
        }

        const adj = new Map();
        nodes.forEach(n => adj.set(n.id, []));
        links.forEach(l => {
            const src = typeof l.source === 'string' ? l.source : l.source.id;
            const tgt = typeof l.target === 'string' ? l.target : l.target.id;
            if (adj.has(src)) adj.get(src).push(tgt);
            if (adj.has(tgt)) adj.get(tgt).push(src);
        });

        const visited = new Map([[startId, 0]]);
        const queue = [startId];

        while (queue.length > 0) {
            const nodeId = queue.shift();
            const depth = visited.get(nodeId);
            if (depth < maxDepth) {
                const neighbors = adj.get(nodeId) || [];
                neighbors.forEach(neighbor => {
                    if (!visited.has(neighbor)) {
                        visited.set(neighbor, depth + 1);
                        queue.push(neighbor);
                    }
                });
            }
        }
        return visited;
    }

    // ========== EVENT LISTENERS ==========
    document.getElementById('search').addEventListener('input', (e) => {
        if (currentView === 'ecosystem') {
            renderGraph(e.target.value.toLowerCase());
        }
    });

    // Community toggle
    document.getElementById('community-toggle').addEventListener('click', () => {
        communityMode = !communityMode;
        document.getElementById('community-toggle').classList.toggle('active', communityMode);
        document.getElementById('community-legend').classList.toggle('visible', communityMode);
        renderGraph(document.getElementById('search').value.toLowerCase());
    });

    // Depth slider
    document.getElementById('depth-slider').addEventListener('input', (e) => {
        depthFilter = parseInt(e.target.value);
        document.getElementById('depth-value').textContent = depthFilter >= 5 ? '‚àû' : depthFilter;
        if (selectedNodeId && currentView === 'ecosystem') {
            applyDepthFilter();
        }
    });

    function clearSelection() {
        selectedNodeId = null;
        document.getElementById('selected-badge').classList.remove('visible');
        document.getElementById('depth-control').style.display = 'none';
        renderGraph(document.getElementById('search').value.toLowerCase());
    }

    function applyDepthFilter() {
        if (!selectedNodeId || currentView !== 'ecosystem') return;

        // Trigger re-render with new depth
        if (graph3D) {
            graph3D.nodeColor(graph3D.nodeColor());
            graph3D.linkColor(graph3D.linkColor());
        }
    }

    function updateCommunityLegend() {
        const legend = document.getElementById('community-legend');
        const uniqueComms = [...new Set(nodeCommunities.values())].sort((a, b) => a - b);

        // Count nodes per community
        const commCounts = new Map();
        nodeCommunities.forEach((comm) => {
            commCounts.set(comm, (commCounts.get(comm) || 0) + 1);
        });

        // Show top communities (max 5)
        const topComms = uniqueComms.slice(0, 5);
        legend.innerHTML = topComms.map(comm => {
            const color = communityColors[comm % communityColors.length];
            const count = commCounts.get(comm) || 0;
            return `<span><span class="community-dot" style="background:${color}"></span>C${comm + 1} (${count})</span>`;
        }).join('');

        if (uniqueComms.length > 5) {
            legend.innerHTML += `<span style="color:var(--text-tertiary)">+${uniqueComms.length - 5} more</span>`;
        }
    }

    function updateUI() {
        const backBtn = document.getElementById('back-btn');
        const currentRepoEl = document.getElementById('current-repo');
        const searchWrapper = document.getElementById('search-wrapper');
        const filterBadge = document.getElementById('filter-badge');

        if (currentView === 'single' && currentRepo) {
            backBtn.classList.add('visible');
            currentRepoEl.classList.add('visible');
            document.getElementById('current-repo-name').textContent = currentRepo.displayName || currentRepo.name;
            searchWrapper.style.display = 'none';
            filterBadge.classList.remove('visible');
        } else {
            backBtn.classList.remove('visible');
            currentRepoEl.classList.remove('visible');
            searchWrapper.style.display = '';

            if (filterLanguage) {
                filterBadge.classList.add('visible');
                document.getElementById('filter-label').textContent = filterLanguage;
            } else {
                filterBadge.classList.remove('visible');
            }
        }
    }

    function filterByLanguage(lang) {
        filterLanguage = lang;
        updateUI();
        renderGraph(document.getElementById('search').value.toLowerCase());
    }

    function clearLanguageFilter() {
        filterLanguage = null;
        updateUI();
        renderGraph(document.getElementById('search').value.toLowerCase());
    }

    function drillIntoRepo(repo) {
        const container = document.getElementById('graph-container');
        container.classList.add('transitioning');

        setTimeout(() => {
            currentView = 'single';
            currentRepo = repo;
            updateUI();
            renderSingleRepoGraph(repo);
            container.classList.remove('transitioning');
        }, 150);
    }

    function goBack() {
        const container = document.getElementById('graph-container');
        container.classList.add('transitioning');
        closeSidePanel();

        setTimeout(() => {
            currentView = 'ecosystem';
            currentRepo = null;
            updateUI();
            renderGraph(document.getElementById('search').value.toLowerCase());
            container.classList.remove('transitioning');
        }, 150);
    }

    function renderGraph(filter) {
        if (currentView === 'ecosystem') {
            renderEcosystemGraph(filter);
        } else if (currentRepo) {
            renderSingleRepoGraph(currentRepo);
        }
    }

    // Type colors for nodes
    const typeColors = {
        repo: '#6366f1',
        directory: '#22c55e',
        language: null,
        framework: '#8b5cf6',
        entry: '#f59e0b',
        config: '#ef4444',
        ci: '#3b82f6',
        docker: '#0ea5e9'
    };

    // Get node color based on type, community, etc.
    function getNodeColor(node) {
        // Dimmed if depth filtered
        if (selectedNodeId && depthFilter < 5) {
            const visible = getNodesWithinDepth(selectedNodeId, depthFilter, currentNodes, currentLinks);
            if (!visible.has(node.id)) {
                return 'rgba(100,100,100,0.2)';
            }
        }

        // Highlight on hover
        if (hoverNode) {
            if (highlightNodes.has(node.id)) {
                // Keep bright
            } else {
                return 'rgba(100,100,100,0.3)';
            }
        }

        // Community coloring
        if (communityMode && nodeCommunities.has(node.id)) {
            return communityColors[nodeCommunities.get(node.id) % communityColors.length];
        }

        // Type-based coloring
        if (node.type === 'language') return getColor(node.name);
        if (typeColors[node.type]) return typeColors[node.type];
        if (node.language) return getColor(node.language);
        return '#888888';
    }

    // Get link color
    function getLinkColor(link) {
        if (hoverNode && !highlightLinks.has(link)) {
            return 'rgba(100,100,100,0.1)';
        }
        if (selectedNodeId && depthFilter < 5) {
            const visible = getNodesWithinDepth(selectedNodeId, depthFilter, currentNodes, currentLinks);
            const src = typeof link.source === 'object' ? link.source.id : link.source;
            const tgt = typeof link.target === 'object' ? link.target.id : link.target;
            if (!visible.has(src) || !visible.has(tgt)) {
                return 'rgba(100,100,100,0.05)';
            }
        }
        if (highlightLinks.has(link)) {
            return 'rgba(255,255,255,0.8)';
        }
        const tgt = typeof link.target === 'object' ? link.target : currentNodes.find(n => n.id === link.target);
        if (tgt && tgt.type === 'language') {
            return getColor(tgt.name) + '40';
        }
        return 'rgba(255,255,255,0.15)';
    }

    // ========== ECOSYSTEM VIEW (3D) ==========
    function renderEcosystemGraph(filter) {
        const container = document.getElementById('graph-container');

        // Clear previous
        if (graph3D) {
            graph3D._destructor && graph3D._destructor();
            graph3D = null;
        }
        container.innerHTML = '';

        let repos = allData;

        // Apply language filter
        if (filterLanguage) {
            repos = repos.filter(f => {
                const kg = f.knowledgeGraph;
                return kg?.languages && Object.keys(kg.languages).includes(filterLanguage);
            });
        }

        // Apply search filter
        if (filter) {
            repos = repos.filter(f =>
                f.name.toLowerCase().includes(filter) ||
                (f.language || '').toLowerCase().includes(filter) ||
                (f.description || '').toLowerCase().includes(filter)
            );
        }

        if (repos.length === 0) {
            container.innerHTML = '<div class="loading"><span>No repos with knowledge graphs found matching your filter.</span></div>';
            return;
        }

        // Build nodes and links
        const nodes = [];
        const links = [];
        const langNodes = new Map();

        // Add language hub nodes
        const langCounts = {};
        repos.forEach(f => {
            if (f.knowledgeGraph?.languages) {
                Object.entries(f.knowledgeGraph.languages).forEach(([lang, count]) => {
                    langCounts[lang] = (langCounts[lang] || 0) + count;
                });
            }
        });

        // Top languages as hub nodes
        const topLangs = Object.entries(langCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 15);

        topLangs.forEach(([lang, count]) => {
            const node = { id: 'lang-' + lang, name: lang, type: 'language', count, val: Math.min(30, 8 + Math.sqrt(count)) };
            nodes.push(node);
            langNodes.set(lang, node);
        });

        // Repo nodes
        repos.forEach(repo => {
            const kg = repo.knowledgeGraph;
            const totalFiles = kg ? Object.values(kg.directories || {}).reduce((a, b) => a + b, 0) : 0;
            const repoNode = {
                id: 'repo-' + repo.name,
                name: repo.displayName || repo.name,
                repoName: repo.name,
                type: 'repo',
                language: repo.language,
                stars: repo.stars || 0,
                description: repo.description,
                summary: repo.summary,
                totalFiles,
                kg,
                val: Math.max(3, Math.min(15, 3 + Math.sqrt(totalFiles) * 0.8))
            };
            nodes.push(repoNode);

            // Link repo to its languages
            if (kg?.languages) {
                const repoLangs = Object.entries(kg.languages).sort((a, b) => b[1] - a[1]);
                repoLangs.forEach(([lang, count]) => {
                    if (langNodes.has(lang)) {
                        links.push({
                            source: repoNode.id,
                            target: 'lang-' + lang,
                            value: count
                        });
                    }
                });
            }
        });

        // Store for depth filter
        currentNodes = nodes;
        currentLinks = links;

        // Run community detection if enabled
        if (communityMode) {
            nodeCommunities = detectCommunities(nodes, links);
            updateCommunityLegend();
        }

        // Get theme
        const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        const bgColor = isDark ? '#030303' : '#ffffff';

        // Create 3D graph
        graph3D = ForceGraph3D()(container)
            .graphData({ nodes, links })
            .backgroundColor(bgColor)
            .nodeVal(n => n.val || 5)
            .nodeColor(n => getNodeColor(n))
            .nodeLabel(n => '')
            .nodeOpacity(0.9)
            .linkWidth(l => Math.max(0.3, Math.min(2, (l.value || 1) / 10)))
            .linkColor(l => getLinkColor(l))
            .linkOpacity(0.6)
            .onNodeHover(node => {
                container.style.cursor = node ? 'pointer' : 'default';
                hoverNode = node;

                // Update highlight sets
                highlightNodes.clear();
                highlightLinks.clear();

                if (node) {
                    highlightNodes.add(node.id);
                    links.forEach(link => {
                        const src = typeof link.source === 'object' ? link.source.id : link.source;
                        const tgt = typeof link.target === 'object' ? link.target.id : link.target;
                        if (src === node.id || tgt === node.id) {
                            highlightNodes.add(src);
                            highlightNodes.add(tgt);
                            highlightLinks.add(link);
                        }
                    });

                    // Show tooltip
                    showTooltip(node, true);
                } else {
                    hideTooltip();
                }

                // Trigger re-render
                graph3D.nodeColor(graph3D.nodeColor());
                graph3D.linkColor(graph3D.linkColor());
            })
            .onNodeClick((node, event) => {
                // Shift+click: select for depth filter
                if (event.shiftKey) {
                    selectedNodeId = node.id;
                    document.getElementById('selected-badge').classList.add('visible');
                    document.getElementById('selected-name').textContent = node.name;
                    document.getElementById('depth-control').style.display = 'flex';
                    graph3D.nodeColor(graph3D.nodeColor());
                    graph3D.linkColor(graph3D.linkColor());
                    return;
                }

                // Normal click
                if (node.type === 'language') {
                    filterByLanguage(node.name);
                } else if (node.type === 'repo' && node.kg) {
                    const repo = allData.find(f => f.name === node.repoName);
                    if (repo) drillIntoRepo(repo);
                }
            })
            .d3Force('charge', d3ForceSimulation => d3ForceSimulation.strength(n => n.type === 'language' ? -150 : -30))
            .d3Force('link', d3ForceSimulation => d3ForceSimulation.distance(l => 50 + (l.value ? 30 / l.value : 0)));

        // Add labels as sprites
        graph3D.nodeThreeObject(node => {
            if (node.type === 'language') {
                const sprite = new SpriteText(node.name);
                sprite.color = getColor(node.name);
                sprite.textHeight = 4;
                sprite.position.y = (node.val || 5) + 5;
                return sprite;
            }
            return false;
        });

        graph3D.nodeThreeObjectExtend(true);
    }

    // ========== SINGLE REPO VIEW (3D) ==========
    function renderSingleRepoGraph(repo) {
        const container = document.getElementById('graph-container');

        // Clear previous
        if (graph3D) {
            graph3D._destructor && graph3D._destructor();
            graph3D = null;
        }
        container.innerHTML = '';

        const kg = repo.knowledgeGraph;
        if (!kg) {
            container.innerHTML = '<div class="loading"><span>No knowledge graph data for this repo.</span></div>';
            return;
        }

        const nodes = [];
        const links = [];

        // Center node: repo
        const centerNode = { id: 'center', name: repo.displayName || repo.name, type: 'repo', val: 20, summary: repo.summary, description: repo.description };
        nodes.push(centerNode);

        // Directory nodes
        Object.entries(kg.directories || {}).sort((a, b) => b[1] - a[1]).slice(0, 12).forEach(([dir, count]) => {
            const n = { id: 'dir-' + dir, name: dir + '/', dirName: dir, type: 'directory', count, val: 5 + Math.sqrt(count) };
            nodes.push(n);
            links.push({ source: 'center', target: n.id, value: count });
        });

        // Language nodes
        Object.entries(kg.languages || {}).sort((a, b) => b[1] - a[1]).slice(0, 10).forEach(([lang, count]) => {
            const reposWithLang = allData.filter(r => r.knowledgeGraph?.languages?.[lang]).length;
            const n = { id: 'lang-' + lang, name: lang, type: 'language', count, reposWithLang, val: 5 + Math.sqrt(count) };
            nodes.push(n);
            links.push({ source: 'center', target: n.id, value: count });
        });

        // Framework nodes
        (kg.frameworks || []).slice(0, 6).forEach((fw, i) => {
            const n = { id: 'fw-' + i, name: fw, type: 'framework', val: 6 };
            nodes.push(n);
            links.push({ source: 'center', target: n.id, value: 2 });
        });

        // Entry point nodes
        (kg.entryPoints || []).slice(0, 6).forEach((ep, i) => {
            const n = { id: 'entry-' + i, name: ep, type: 'entry', val: 4 };
            nodes.push(n);
            links.push({ source: 'center', target: n.id, value: 1 });
        });

        // Config nodes
        (kg.configFiles || []).slice(0, 6).forEach((cf, i) => {
            const n = { id: 'config-' + i, name: cf, type: 'config', val: 3 };
            nodes.push(n);
            links.push({ source: 'center', target: n.id, value: 1 });
        });

        // CI/CD node
        if (kg.hasCI && kg.ciPlatform) {
            const n = { id: 'ci', name: kg.ciPlatform, type: 'ci', val: 5 };
            nodes.push(n);
            links.push({ source: 'center', target: n.id, value: 1 });
        }

        // Docker node
        if (kg.hasDocker) {
            const n = { id: 'docker', name: 'Docker', type: 'docker', val: 5 };
            nodes.push(n);
            links.push({ source: 'center', target: n.id, value: 1 });
        }

        currentNodes = nodes;
        currentLinks = links;

        const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        const bgColor = isDark ? '#030303' : '#ffffff';

        graph3D = ForceGraph3D()(container)
            .graphData({ nodes, links })
            .backgroundColor(bgColor)
            .nodeVal(n => n.val || 5)
            .nodeColor(n => {
                if (n.type === 'language') return getColor(n.name);
                return typeColors[n.type] || '#888';
            })
            .nodeLabel(n => '')
            .nodeOpacity(0.9)
            .linkWidth(1)
            .linkColor(() => 'rgba(255,255,255,0.3)')
            .onNodeHover(node => {
                container.style.cursor = node ? 'pointer' : 'default';
                if (node) {
                    showTooltipSingleRepo(node, repo);
                } else {
                    hideTooltip();
                }
            })
            .onNodeClick((node) => {
                const repoUrl = repo.url || `https://github.com/moses-y/${repo.name}`;

                if (node.type === 'repo') {
                    window.open(repoUrl, '_blank');
                } else if (node.type === 'directory') {
                    const dirPath = node.dirName === '(root)' ? '' : node.dirName;
                    window.open(`${repoUrl}/tree/main/${dirPath}`, '_blank');
                } else if (node.type === 'language') {
                    goBack();
                    setTimeout(() => filterByLanguage(node.name), 200);
                } else if (node.type === 'entry' || node.type === 'config') {
                    window.open(`${repoUrl}/blob/main/${node.name}`, '_blank');
                } else if (node.type === 'ci') {
                    window.open(`${repoUrl}/tree/main/.github/workflows`, '_blank');
                } else if (node.type === 'docker') {
                    window.open(`${repoUrl}/blob/main/Dockerfile`, '_blank');
                } else if (node.type === 'framework') {
                    window.open(`${repoUrl}/search?q=${encodeURIComponent(node.name)}`, '_blank');
                }
            });

        // Add labels
        graph3D.nodeThreeObject(node => {
            const sprite = new SpriteText(node.type === 'repo' ? node.name : (node.type === 'config' || node.type === 'entry' ? node.name.split('/').pop() : node.name));
            sprite.color = node.type === 'language' ? getColor(node.name) : (node.type === 'repo' ? '#ffffff' : '#aaaaaa');
            sprite.textHeight = node.type === 'repo' ? 5 : 3;
            sprite.position.y = (node.val || 5) + 4;
            return sprite;
        });

        graph3D.nodeThreeObjectExtend(true);

        // Auto-open side panel
        openSidePanel({ name: repo.displayName || repo.name, repoName: repo.name, description: repo.description, stars: repo.stars, kg, totalFiles: Object.values(kg.directories || {}).reduce((a, b) => a + b, 0) }, repo.url);
    }

    // ========== TOOLTIPS ==========
    function showTooltip(node, isEcosystem) {
        const tooltip = document.getElementById('tooltip');
        let html = '';

        const commInfo = communityMode && nodeCommunities.has(node.id)
            ? `<span class="tag" style="background:${communityColors[nodeCommunities.get(node.id) % communityColors.length]}40;border-color:${communityColors[nodeCommunities.get(node.id) % communityColors.length]}">Cluster ${nodeCommunities.get(node.id) + 1}</span>`
            : '';

        if (node.type === 'language') {
            const repoCount = currentLinks.filter(l => {
                const tgt = typeof l.target === 'object' ? l.target.id : l.target;
                return tgt === node.id;
            }).length;
            html = `<h4>${node.name}</h4>${commInfo}<div class="detail">${node.count} files across ${repoCount} repos</div>`;
            html += `<div class="click-hint">Click to filter ¬∑ Shift+click to select</div>`;
        } else {
            html = `<h4>${node.name}</h4>${commInfo}`;
            if (node.kg?.languages) {
                const langs = Object.entries(node.kg.languages).sort((a, b) => b[1] - a[1]).slice(0, 5);
                html += '<div style="margin-top:4px">' + langs.map(([l, c]) => `<span class="tag">${l}: ${c}</span>`).join('') + '</div>';
            }
            html += `<div class="detail" style="margin-top:4px">${node.totalFiles || 0} files ¬∑ ‚òÖ ${node.stars || 0}</div>`;
            if (node.summary) {
                html += `<div class="summary">${node.summary.slice(0, 150)}...</div>`;
            } else if (node.description) {
                html += `<div class="summary">${node.description}</div>`;
            }
            html += `<div class="click-hint">Click to explore ¬∑ Shift+click to select</div>`;
        }

        tooltip.innerHTML = html;
        tooltip.style.left = '50%';
        tooltip.style.top = '120px';
        tooltip.style.transform = 'translateX(-50%)';
        tooltip.classList.add('visible');
    }

    function showTooltipSingleRepo(node, repo) {
        const tooltip = document.getElementById('tooltip');
        let html = `<h4>${node.name}</h4>`;

        if (node.count) html += `<div class="detail">${node.count} files</div>`;
        if (node.type === 'language' && node.reposWithLang) {
            html += `<div class="detail">${node.reposWithLang} repos use ${node.name}</div>`;
        }
        if (node.type === 'repo' && (node.summary || node.description)) {
            html += `<div class="summary">${(node.summary || node.description).slice(0, 150)}</div>`;
        }

        const hints = {
            repo: 'Click to open on GitHub',
            directory: 'Click to browse folder',
            language: 'Click to filter all repos',
            entry: 'Click to view file',
            config: 'Click to view file',
            framework: 'Click to search in repo',
            ci: 'Click to view workflows',
            docker: 'Click to view Dockerfile'
        };
        html += `<div class="click-hint">${hints[node.type] || 'Click to interact'}</div>`;

        tooltip.innerHTML = html;
        tooltip.style.left = '50%';
        tooltip.style.top = '120px';
        tooltip.style.transform = 'translateX(-50%)';
        tooltip.classList.add('visible');
    }

    function hideTooltip() {
        document.getElementById('tooltip').classList.remove('visible');
    }

    // ========== SIDE PANEL ==========
    function openSidePanel(d, repoUrl) {
        const panel = document.getElementById('side-panel');
        const content = document.getElementById('panel-content');
        const kg = d.kg;
        const ghUrl = repoUrl || `https://github.com/moses-y/${d.repoName}`;

        let html = `<h3>${d.name}</h3>`;
        html += `<a href="${ghUrl}" target="_blank" class="github-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
            View on GitHub
        </a>`;
        if (d.description) html += `<p style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:1rem">${d.description}</p>`;

        // Tech stack badges
        const badges = [];
        if (kg.frameworks && kg.frameworks.length > 0) {
            kg.frameworks.forEach(fw => badges.push(`<span class="tag" style="background:rgba(139,92,246,0.2);border-color:rgba(139,92,246,0.4)">üîß ${fw}</span>`));
        }
        if (kg.hasDocker) badges.push(`<span class="tag" style="background:rgba(14,165,233,0.2);border-color:rgba(14,165,233,0.4)">üê≥ Docker</span>`);
        if (kg.hasCI) badges.push(`<span class="tag" style="background:rgba(59,130,246,0.2);border-color:rgba(59,130,246,0.4)">üîÑ ${kg.ciPlatform}</span>`);
        if (kg.packageManager) badges.push(`<span class="tag" style="background:rgba(34,197,94,0.2);border-color:rgba(34,197,94,0.4)">üì¶ ${kg.packageManager}</span>`);

        if (badges.length > 0) {
            html += '<div class="panel-section"><h4>Tech Stack</h4>';
            html += '<div style="display:flex;flex-wrap:wrap;gap:4px">' + badges.join('') + '</div>';
            html += '</div>';
        }

        // Languages
        if (kg.languages && Object.keys(kg.languages).length > 0) {
            const sorted = Object.entries(kg.languages).sort((a, b) => b[1] - a[1]);
            const max = sorted[0][1];
            html += '<div class="panel-section"><h4>Languages</h4>';
            sorted.slice(0, 8).forEach(([lang, count]) => {
                const pct = Math.round(count / max * 100);
                html += `<div class="bar"><span class="bar-label">${lang}</span><div class="bar-fill" style="width:${pct}px;background:${getColor(lang)}"></div><span class="bar-count">${count}</span></div>`;
            });
            html += '</div>';
        }

        // Directories
        if (kg.directories && Object.keys(kg.directories).length > 0) {
            const sorted = Object.entries(kg.directories).sort((a, b) => b[1] - a[1]);
            const max = sorted[0][1];
            html += '<div class="panel-section"><h4>Directories</h4>';
            sorted.slice(0, 8).forEach(([dir, count]) => {
                const pct = Math.round(count / max * 100);
                const ghUrl = repoUrl || `https://github.com/moses-y/${d.repoName}`;
                const dirLink = dir === '(root)' ? ghUrl : `${ghUrl}/tree/main/${dir}`;
                html += `<div class="bar" style="cursor:pointer" onclick="window.open('${dirLink}','_blank')"><span class="bar-label">${dir}/</span><div class="bar-fill" style="width:${pct}px;background:#22c55e"></div><span class="bar-count">${count}</span></div>`;
            });
            html += '</div>';
        }

        // Entry points
        if (kg.entryPoints && kg.entryPoints.length > 0) {
            html += '<div class="panel-section"><h4>Entry Points</h4><ul class="file-list">';
            kg.entryPoints.slice(0, 6).forEach(f => {
                const ghUrl = repoUrl || `https://github.com/moses-y/${d.repoName}`;
                html += `<li style="cursor:pointer" onclick="window.open('${ghUrl}/blob/main/${f}','_blank')">üöÄ ${f}</li>`;
            });
            html += '</ul></div>';
        }

        // Config files
        if (kg.configFiles && kg.configFiles.length > 0) {
            html += '<div class="panel-section"><h4>Config & Build</h4><ul class="file-list">';
            kg.configFiles.slice(0, 8).forEach(f => {
                const ghUrl = repoUrl || `https://github.com/moses-y/${d.repoName}`;
                html += `<li style="cursor:pointer" onclick="window.open('${ghUrl}/blob/main/${f}','_blank')">‚öôÔ∏è ${f}</li>`;
            });
            html += '</ul></div>';
        }

        // Dependencies
        if (kg.dependencies && kg.dependencies.length > 0) {
            html += '<div class="panel-section"><h4>Dependency Files</h4><ul class="file-list">';
            kg.dependencies.forEach(f => {
                const ghUrl = repoUrl || `https://github.com/moses-y/${d.repoName}`;
                html += `<li style="cursor:pointer" onclick="window.open('${ghUrl}/blob/main/${f}','_blank')">üì¶ ${f}</li>`;
            });
            html += '</ul></div>';
        }

        // Stats
        html += '<div class="panel-section"><h4>Stats</h4>';
        html += `<div class="detail">Total files: ${kg.totalFiles || d.totalFiles || '‚Äî'}</div>`;
        html += `<div class="detail">Tests: ${kg.testFiles?.length || 0} files</div>`;
        html += `<div class="detail">Docs: ${kg.docs?.length || 0} files</div>`;
        if (d.stars !== undefined) html += `<div class="detail">Stars: ‚òÖ ${d.stars}</div>`;
        html += '</div>';

        content.innerHTML = html;
        panel.classList.add('open');
    }

    function closeSidePanel() {
        document.getElementById('side-panel').classList.remove('open');
    }

    // Init
    loadData();
    </script>
</body>
</html>
